<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æœ€å¼·ãƒ¬ã‚·ãƒ¼ãƒˆå‰²ã‚Šå‹˜</title>
<script src="https://unpkg.com/tesseract.js@4/dist/tesseract.min.js"></script>

<style>
body{
  font-family: sans-serif;
  padding:16px;
  background:#f4f6f8;
}

h2{
  margin-top:24px;
}

input, button, select{
  width:100%;
  padding:12px;
  margin-top:8px;
  margin-bottom:8px;
  font-size:16px;
  border-radius:8px;
  border:1px solid #ccc;
}

button{
  background:#4f7cff;
  color:white;
  border:none;
}

button:active{
  opacity:0.8;
}

.card{
  background:white;
  padding:12px;
  margin-bottom:10px;
  border-radius:12px;
  box-shadow:0 2px 6px rgba(0,0,0,0.1);
}

.result{
  font-size:18px;
  font-weight:bold;
}
</style>
</head>

<body>

<h2>ğŸ‘¤ åå‰ç™»éŒ²</h2>
<input type="text" id="name1" placeholder="1äººç›®ã®åå‰">
<input type="text" id="name2" placeholder="2äººç›®ã®åå‰">
<button onclick="registerNames()">ç™»éŒ²</button>

<h2>ğŸ§¾ ãƒ¬ã‚·ãƒ¼ãƒˆèª­ã¿å–ã‚Š</h2>
<input type="file" id="imageInput" disabled>

<div id="shopInfo"></div>
<div id="itemsArea"></div>

<h2>ğŸ’° è¨ˆç®—</h2>
<button onclick="calculate()">è¨ˆç®—ã™ã‚‹</button>
<div id="result" class="result"></div>

<script>
let person1 = "";
let person2 = "";

const input = document.getElementById("imageInput");
const itemsArea = document.getElementById("itemsArea");
const result = document.getElementById("result");
const shopInfo = document.getElementById("shopInfo");

window.onload = function(){
  const saved1 = localStorage.getItem("person1");
  const saved2 = localStorage.getItem("person2");

  if(saved1 && saved2){
    document.getElementById("name1").value = saved1;
    document.getElementById("name2").value = saved2;
    person1 = saved1;
    person2 = saved2;
    input.disabled = false;
  }
}

function registerNames(){
  const n1 = document.getElementById("name1").value.trim();
  const n2 = document.getElementById("name2").value.trim();

  if(!n1 || !n2){
    alert("2äººã¨ã‚‚åå‰å…¥ã‚Œã¦ã­ï¼");
    return;
  }

  person1 = n1;
  person2 = n2;

  localStorage.setItem("person1", person1);
  localStorage.setItem("person2", person2);

  input.disabled = false;
  alert("ä¿å­˜å®Œäº†âœ¨");
}

input.addEventListener("change", async ()=>{
  const file = input.files[0];
  if(!file) return;

  itemsArea.innerHTML = "èª­ã¿å–ã‚Šä¸­â€¦";

  const { data:{ text } } = await Tesseract.recognize(file,"jpn+eng");

  extractShopInfo(text);
  displayItems(text);
});

function normalizeNumbers(str){
  return str
    .replace(/[â‘ ]/g,"1")
    .replace(/[â‘¡]/g,"2")
    .replace(/[â‘¢]/g,"3")
    .replace(/[â‘£]/g,"4")
    .replace(/[â‘¤]/g,"5")
    .replace(/[â‘¥]/g,"6")
    .replace(/[â‘¦]/g,"7")
    .replace(/[â‘§]/g,"8")
    .replace(/[â‘¨]/g,"9")
    .replace(/[â“ª]/g,"0");
}

function extractShopInfo(text){
  const lines = text.split("\n");
  let shopName="";
  let date="";

  lines.forEach(line=>{
    const cleaned = normalizeNumbers(line);

    if(!shopName && cleaned.match(/åº—|ã‚¹ãƒ¼ãƒ‘ãƒ¼|SHOP/)){
      shopName = cleaned;
    }

    if(!date){
      const match = cleaned.match(/\d{4}\/\d{1,2}\/\d{1,2}/);
      if(match) date = match[0];
    }
  });

  shopInfo.innerHTML = `
    <div class="card">
      ğŸª ${shopName || "åº—åä¸æ˜"}<br>
      ğŸ“… ${date || "æ—¥ä»˜ä¸æ˜"}
    </div>
  `;
}

function displayItems(text){
  itemsArea.innerHTML="";
  const lines = text.split("\n");

  lines.forEach(line=>{
    let cleaned = line.replace(/\s/g,"");
    cleaned = normalizeNumbers(cleaned);

    if(cleaned.match(/TEL|ç™»éŒ²|ç•ªå·|æ—¥æ™‚|æ‹…å½“|å°è¨ˆ|åˆè¨ˆ|é |ã¤ã‚Š/)) return;

    const match = cleaned.match(/(.+?)[Â¥\\ï¿¥]?([\d,]{2,})$/);
    if(!match) return;

    const name = match[1];
    const price = parseInt(match[2].replace(/,/g,""));
    if(price<10) return;

    const div = document.createElement("div");
    div.className="card";
    div.innerHTML=`
      ${name} - ${price}å††
      <select>
        <option value="shared">å‰²ã‚Šå‹˜</option>
        <option value="p1">${person1}</option>
        <option value="p2">${person2}</option>
      </select>
    `;
    div.dataset.price=price;
    itemsArea.appendChild(div);
  });
}

function calculate(){
  let p1=0;
  let p2=0;
  let shared=0;

  const items = itemsArea.children;

  for(let item of items){
    const price=parseInt(item.dataset.price);
    const select=item.querySelector("select").value;

    if(select==="p1") p1+=price;
    else if(select==="p2") p2+=price;
    else shared+=price;
  }

  const half=Math.ceil(shared/2);
  p1+=half;
  p2+=half;

  result.innerHTML=`
    ${person1}: ${p1} å††<br>
    ${person2}: ${p2} å††
  `;
}
</script>

</body>
</html>
