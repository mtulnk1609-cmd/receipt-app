<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ãƒ¬ã‚·ãƒ¼ãƒˆå‰²ã‚Šå‹˜ã‚¢ãƒ—ãƒªï¼ˆã‚«ãƒ¡ãƒ©ç›´æ¥OCRï¼‰</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://unpkg.com/tesseract.js@4/dist/tesseract.min.js"></script>
<style>
body { font-family:sans-serif; padding:16px; background:#f4f6f8; }
input, button, select, textarea { width:100%; padding:10px; margin:6px 0; font-size:16px; border-radius:8px; border:1px solid #ccc; }
button { background:#4f7cff; color:white; border:none; cursor:pointer; }
textarea { height:180px; }
.card { background:white; padding:8px; margin:6px 0; border-radius:8px; box-shadow:0 1px 4px rgba(0,0,0,0.1); display:flex; gap:6px; align-items:center;}
.card span { flex:1; }
video { width:100%; border-radius:8px; margin:6px 0;}
</style>
</head>
<body>

<h2>ğŸ‘¤ åå‰ç™»éŒ²</h2>
<input type="text" id="name1" placeholder="1äººç›®ã®åå‰">
<input type="text" id="name2" placeholder="2äººç›®ã®åå‰">
<button onclick="registerNames()">ç™»éŒ²</button>

<h2>ğŸ“ ãƒ¬ã‚·ãƒ¼ãƒˆèª­ã¿å–ã‚Š</h2>
<label>æ—¥ä»˜: <input type="text" id="dateInput" placeholder="YYYY/MM/DD"></label>
<label>ãŠåº—ã®åå‰: <input type="text" id="shopInput" placeholder="ã‚¹ãƒ¼ãƒ‘ãƒ¼åãªã©"></label>

<video id="video" autoplay></video>
<button onclick="captureFrame()">èª­ã¿å–ã‚Š</button>

<div id="itemsArea"></div>

<h2>ã¾ã¨ã‚</h2>
<button onclick="generateSummary()">ã¾ã¨ã‚ä½œæˆï¼ˆè‡ªå‹•ã‚³ãƒ”ãƒ¼ä»˜ãï¼‰</button>
<textarea id="summaryOutput" readonly placeholder="ã“ã“ã«ã¾ã¨ã‚ãƒ†ã‚­ã‚¹ãƒˆãŒå‡ºã‚‹ã‚ˆ"></textarea>

<canvas id="canvas" style="display:none;"></canvas>

<script>
let person1="", person2="";
window.onload=function(){
  const saved1=localStorage.getItem("person1");
  const saved2=localStorage.getItem("person2");
  if(saved1 && saved2){
    document.getElementById("name1").value = saved1;
    document.getElementById("name2").value = saved2;
    person1=saved1; person2=saved2;
  }

  // ã‚«ãƒ¡ãƒ©èµ·å‹•
  const video=document.getElementById("video");
  navigator.mediaDevices.getUserMedia({video:true})
    .then(stream => { video.srcObject = stream; })
    .catch(err => alert("ã‚«ãƒ¡ãƒ©èµ·å‹•ã§ããªã„ã‚ˆğŸ’¦"));
}

function registerNames(){
  const n1=document.getElementById("name1").value.trim();
  const n2=document.getElementById("name2").value.trim();
  if(!n1||!n2){ alert("2äººã¨ã‚‚åå‰å…¥ã‚Œã¦ã­ï¼"); return; }
  person1=n1; person2=n2;
  localStorage.setItem("person1",person1);
  localStorage.setItem("person2",person2);
  alert("åå‰ç™»éŒ²å®Œäº†âœ¨");
}

function cleanLine(line){
  let l = line.replace(/[Â¥ï¿¥]/g,'Â¥');           
  l = l.replace(/[ï¼-ï¼™]/g,c=>String.fromCharCode(c.charCodeAt(0)-0xFEE0));
  l = l.replace(/\s/g,'');                     
  return l;
}

function displayItems(text){
  const itemsArea=document.getElementById("itemsArea");
  itemsArea.innerHTML="";
  const lines=text.split("\n");
  lines.forEach((line)=>{
    let cleaned = cleanLine(line);
    if(cleaned.match(/TEL|ç™»éŒ²|ç•ªå·|æ—¥æ™‚|æ‹…å½“|å°è¨ˆ|åˆè¨ˆ|é |ã¤ã‚Š/)) return;
    const match=cleaned.match(/(.+?)[Â¥\\]?([\d,]{1,})$/);
    if(!match) return;
    const itemName=match[1];
    const price=parseInt(match[2].replace(/,/g,""));
    if(price<10) return;
    const div=document.createElement("div"); div.className="card";
    div.innerHTML=`<span>${itemName} - Â¥${price}</span>
      <select class="choice">
        <option value="shared" selected>å‰²ã‚Šå‹˜</option>
        <option value="person1">${person1}</option>
        <option value="person2">${person2}</option>
      </select>
      <select class="tax">
        <option value="0.08" selected>ç¨è¾¼8%</option>
        <option value="0.10">ç¨è¾¼10%</option>
      </select>`;
    itemsArea.appendChild(div);
  });
}

function captureFrame(){
  const video=document.getElementById("video");
  const canvas=document.getElementById("canvas");
  canvas.width=video.videoWidth;
  canvas.height=video.videoHeight;
  const ctx=canvas.getContext("2d");
  ctx.drawImage(video,0,0,canvas.width,canvas.height);
  const dataUrl=canvas.toDataURL();
  itemsArea.innerHTML="<em>èª­ã¿å–ã‚Šä¸­â€¦</em>";
  Tesseract.recognize(dataUrl,'jpn+eng').then(({data:{text}})=>{
    displayItems(text);
  });
}

function generateSummary(){
  const date=document.getElementById("dateInput").value||"æœªå…¥åŠ›";
  const shop=document.getElementById("shopInput").value||"æœªå…¥åŠ›";
  let summary=`æ—¥ä»˜: ${date}\nãŠåº—: ${shop}\n\n`;
  let total1=0, total2=0;
  const cards=document.querySelectorAll("#itemsArea .card");
  cards.forEach((card)=>{
    const span=card.querySelector("span").textContent;
    const choice=card.querySelector(".choice").value;
    const tax=parseFloat(card.querySelector(".tax").value);
    const price=parseInt(span.match(/Â¥(\d+)/)[1]);
    const priceTaxed=Math.round(price*(1+tax));
    summary+=`${span} â†’ ${choice} ç¨è¾¼${priceTaxed}å††\n`;
    if(choice==="shared"){ total1+=Math.round(priceTaxed/2); total2+=Math.round(priceTaxed/2); }
    else if(choice==="person1"){ total1+=priceTaxed; }
    else if(choice==="person2"){ total2+=priceTaxed; }
  });
  summary+=`\n${person1} åˆè¨ˆ: Â¥${total1}\n${person2} åˆè¨ˆ: Â¥${total2}`;
  document.getElementById("summaryOutput").value=summary;

  const lines=summary.split("\n");
  const totalLines=lines.slice(-2).join("\n");
  navigator.clipboard.writeText(totalLines)
    .then(()=>console.log("åˆè¨ˆã‚’è‡ªå‹•ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸâœ¨"))
    .catch(()=>console.log("è‡ªå‹•ã‚³ãƒ”ãƒ¼å¤±æ•—ğŸ’¦"));
}
</script>

</body>
</html>
