<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ãƒ¬ã‚·ãƒ¼ãƒˆå‰²ã‚Šå‹˜ã‚¢ãƒ—ãƒªï¼ˆæœ€çµ‚ç‰ˆï¼‰</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://unpkg.com/tesseract.js@4/dist/tesseract.min.js"></script>
<style>
body { font-family:sans-serif; padding:16px; background:#f4f6f8; }
input, button, select, textarea { width:100%; padding:10px; margin:6px 0; font-size:16px; border-radius:8px; border:1px solid #ccc; }
button { background:#4f7cff; color:white; border:none; cursor:pointer; }
textarea { height:150px; }
.card { background:white; padding:8px; margin:6px 0; border-radius:8px; box-shadow:0 1px 4px rgba(0,0,0,0.1); display:flex; justify-content:space-between; align-items:center; gap:6px;}
</style>
</head>
<body>

<h2>ğŸ‘¤ åå‰ç™»éŒ²</h2>
<input type="text" id="name1" placeholder="1äººç›®ã®åå‰">
<input type="text" id="name2" placeholder="2äººç›®ã®åå‰">
<button onclick="registerNames()">ç™»éŒ²</button>

<h2>ğŸ“ ãƒ¬ã‚·ãƒ¼ãƒˆèª­ã¿å–ã‚Š</h2>
<label>æ—¥ä»˜: <input type="text" id="dateInput" placeholder="YYYY/MM/DD"></label>
<label>ãŠåº—ã®åå‰: <input type="text" id="shopInput" placeholder="ã‚¹ãƒ¼ãƒ‘ãƒ¼åãªã©"></label>
<input type="file" id="imageInput" accept="image/*">
<div id="itemsArea"></div>

<h2>ã¾ã¨ã‚</h2>
<button onclick="generateSummary()">ã¾ã¨ã‚ä½œæˆ</button>
<textarea id="summaryOutput" readonly placeholder="ã“ã“ã«ã¾ã¨ã‚ãƒ†ã‚­ã‚¹ãƒˆãŒå‡ºã‚‹ã‚ˆ"></textarea>

<script>
let person1="", person2="";
window.onload=function(){
  const saved1 = localStorage.getItem("person1");
  const saved2 = localStorage.getItem("person2");
  if(saved1 && saved2){
    document.getElementById("name1").value = saved1;
    document.getElementById("name2").value = saved2;
    person1 = saved1;
    person2 = saved2;
  }
}
function registerNames(){
  const n1=document.getElementById("name1").value.trim();
  const n2=document.getElementById("name2").value.trim();
  if(!n1||!n2){ alert("2äººã¨ã‚‚åå‰å…¥ã‚Œã¦ã­ï¼"); return; }
  person1=n1; person2=n2;
  localStorage.setItem("person1",person1);
  localStorage.setItem("person2",person2);
  alert("åå‰ç™»éŒ²å®Œäº†âœ¨");
}

const input=document.getElementById("imageInput");
const itemsArea=document.getElementById("itemsArea");
input.addEventListener("change", async ()=>{
  const file=input.files[0];
  if(!file) return;
  itemsArea.innerHTML="<em>èª­ã¿å–ã‚Šä¸­â€¦</em>";
  const {data:{text}}=await Tesseract.recognize(file,"jpn+eng");
  displayItems(text);
});

function normalizeNumbers(str){ return str.replace(/[â‘ â‘¡â‘¢â‘£â‘¤â‘¥â‘¦â‘§â‘¨â“ª]/g,m=>"â‘ â‘¡â‘¢â‘£â‘¤â‘¥â‘¦â‘§â‘¨â“ª".indexOf(m)); }

function displayItems(text){
  itemsArea.innerHTML="";
  const lines=text.split("\n");
  lines.forEach((line,i)=>{
    let cleaned=line.replace(/\s/g,""); cleaned=normalizeNumbers(cleaned);
    if(cleaned.match(/TEL|ç™»éŒ²|ç•ªå·|æ—¥æ™‚|æ‹…å½“|å°è¨ˆ|åˆè¨ˆ|é |ã¤ã‚Š/)) return;
    const match=cleaned.match(/(.+?)[Â¥\\ï¿¥]?([\d,]{1,})$/);
    if(!match) return;
    const itemName=match[1];
    const price=parseInt(match[2].replace(/,/g,""));
    if(price<10) return;
    const div=document.createElement("div"); div.className="card";
    div.innerHTML=`<span>${itemName} - Â¥${price}</span>
      <select id="choice${i}">
        <option value="shared" selected>å‰²ã‚Šå‹˜</option>
        <option value="person1">${person1}</option>
        <option value="person2">${person2}</option>
      </select>
      <select id="tax${i}">
        <option value="0.08" selected>ç¨è¾¼8%</option>
        <option value="0.10">ç¨è¾¼10%</option>
      </select>`;
    itemsArea.appendChild(div);
  });
}

function generateSummary(){
  const date=document.getElementById("dateInput").value||"æœªå…¥åŠ›";
  const shop=document.getElementById("shopInput").value||"æœªå…¥åŠ›";
  let summary=`æ—¥ä»˜: ${date}\nãŠåº—: ${shop}\n\n`;
  let total1=0, total2=0;
  const cards=document.querySelectorAll("#itemsArea .card");
  cards.forEach((card,i)=>{
    const span=card.querySelector("span").textContent;
    const choice=card.querySelector(`#choice${i}`).value;
    const tax=parseFloat(card.querySelector(`#tax${i}`).value);
    const price=parseInt(span.match(/Â¥(\d+)/)[1]);
    const priceTaxed=Math.round(price*(1+tax));
    summary+=`${span} â†’ ${choice} ç¨è¾¼${priceTaxed}å††\n`;
    if(choice==="shared"){
      total1+=Math.round(priceTaxed/2);
      total2+=Math.round(priceTaxed/2);
    } else if(choice==="person1"){
      total1+=priceTaxed;
    } else if(choice==="person2"){
      total2+=priceTaxed;
    }
  });
  summary+=`\n${person1} åˆè¨ˆ: Â¥${total1}\n${person2} åˆè¨ˆ: Â¥${total2}`;
  document.getElementById("summaryOutput").value=summary;
}
</script>
</body>
</html>
