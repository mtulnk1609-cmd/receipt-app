<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ãƒ¬ã‚·ãƒ¼ãƒˆå‰²ã‚Šå‹˜ã‚¢ãƒ—ãƒª</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://unpkg.com/tesseract.js@4/dist/tesseract.min.js"></script>
<style>
body { font-family: sans-serif; padding:16px; background:#f4f6f8;}
h2 { margin-top:24px; }
input, button, select, textarea { width:100%; padding:10px; margin:6px 0; font-size:16px; border-radius:8px; border:1px solid #ccc; }
button { background:#4f7cff; color:white; border:none; }
textarea { height:120px; }
.card { background:white; padding:8px; margin:6px 0; border-radius:8px; box-shadow:0 1px 4px rgba(0,0,0,0.1); }
.result { font-size:18px; font-weight:bold; }
</style>
</head>
<body>

<h2>ğŸ‘¤ åå‰ç™»éŒ²</h2>
<input type="text" id="name1" placeholder="1äººç›®ã®åå‰">
<input type="text" id="name2" placeholder="2äººç›®ã®åå‰">
<button onclick="registerNames()">ç™»éŒ²</button>

<h2>ğŸ§¾ ãƒ¬ã‚·ãƒ¼ãƒˆèª­ã¿å–ã‚Š</h2>
<label>æ—¥ä»˜: <input type="date" id="dateInput"></label>
<label>ãŠåº—ã®åå‰: <input type="text" id="shopInput" placeholder="ã‚¹ãƒ¼ãƒ‘ãƒ¼åãªã©"></label>
<input type="file" id="imageInput" disabled>

<div id="shopInfo"></div>
<div id="itemsArea"></div>

<h2>ğŸ’° è¨ˆç®—ãƒ»ã¾ã¨ã‚</h2>
<button onclick="calculate()">è¨ˆç®—ã—ã¦ã¾ã¨ã‚</button>
<textarea id="summaryOutput" readonly placeholder="ã“ã“ã«ã¾ã¨ã‚ãƒ†ã‚­ã‚¹ãƒˆãŒå‡ºã‚‹ã‚ˆ"></textarea>

<script>
let person1 = "";
let person2 = "";

const input = document.getElementById("imageInput");
const itemsArea = document.getElementById("itemsArea");
const resultArea = document.getElementById("summaryOutput");
const shopInfo = document.getElementById("shopInfo");

window.onload = function() {
  const saved1 = localStorage.getItem("person1");
  const saved2 = localStorage.getItem("person2");
  if (saved1 && saved2) {
    document.getElementById("name1").value = saved1;
    document.getElementById("name2").value = saved2;
    person1 = saved1;
    person2 = saved2;
    input.disabled = false;
  }
}

function registerNames() {
  const n1 = document.getElementById("name1").value.trim();
  const n2 = document.getElementById("name2").value.trim();
  if (!n1 || !n2) {
    alert("2äººã¨ã‚‚åå‰å…¥ã‚Œã¦ã­ï¼");
    return;
  }
  person1 = n1;
  person2 = n2;
  localStorage.setItem("person1", person1);
  localStorage.setItem("person2", person2);
  input.disabled = false;
  alert("åå‰ç™»éŒ²å®Œäº†âœ¨");
}

input.addEventListener("change", async () => {
  const file = input.files[0];
  if (!file) return;
  itemsArea.innerHTML = "<em>èª­ã¿å–ã‚Šä¸­â€¦</em>";
  const { data: { text } } = await Tesseract.recognize(file, "jpn+eng");
  extractShopInfo(text);
  displayItems(text);
});

function normalizeNumbers(str) {
  return str.replace(/[â‘ ]/g,"1").replace(/[â‘¡]/g,"2").replace(/[â‘¢]/g,"3")
            .replace(/[â‘£]/g,"4").replace(/[â‘¤]/g,"5").replace(/[â‘¥]/g,"6")
            .replace(/[â‘¦]/g,"7").replace(/[â‘§]/g,"8").replace(/[â‘¨]/g,"9")
            .replace(/[â“ª]/g,"0");
}

function extractShopInfo(text) {
  const lines = text.split("\n");
  let shopName="", date="";
  lines.forEach(line => {
    const cleaned = normalizeNumbers(line);
    if (!shopName && cleaned.match(/åº—|ã‚¹ãƒ¼ãƒ‘ãƒ¼|SHOP/)) {
      shopName = cleaned;
    }
    if (!date) {
      const m = cleaned.match(/\d{4}\/\d{1,2}\/\d{1,2}/);
      if (m) date = m[0];
    }
  });
  if (!document.getElementById("dateInput").value) {
    document.getElementById("dateInput").value = date;
  }
  if (!document.getElementById("shopInput").value) {
    document.getElementById("shopInput").value = shopName;
  }
  shopInfo.innerHTML = `
    <div class="card">
      ğŸª ${shopName || "åº—åä¸æ˜"}<br>
      ğŸ“… ${date || "æ—¥ä»˜ä¸æ˜"}
    </div>`;
}

function displayItems(text) {
  itemsArea.innerHTML = "";
  const lines = text.split("\n");
  lines.forEach(line => {
    let cleaned = line.replace(/\s/g,"");
    cleaned = normalizeNumbers(cleaned);
    if (cleaned.match(/TEL|ç™»éŒ²|ç•ªå·|æ—¥æ™‚|æ‹…å½“|å°è¨ˆ|åˆè¨ˆ|é |ã¤ã‚Š/)) return;
    const match = cleaned.match(/(.+?)[Â¥\\ï¿¥]?([\d,]{2,})$/);
    if (!match) return;
    const name = match[1];
    const price = parseInt(match[2].replace(/,/g,""));
    if (price < 10) return;
    const div = document.createElement("div");
    div.className="card";
    div.innerHTML=`
      ${name} - ${price}å††
      <select>
        <option value="shared">å‰²ã‚Šå‹˜</option>
        <option value="p1">${person1}</option>
        <option value="p2">${person2}</option>
      </select>
    `;
    div.dataset.price = price;
    itemsArea.appendChild(div);
  });
}

function calculate() {
  const date = document.getElementById("dateInput").value;
  const shop = document.getElementById("shopInput").value;
  let p1=0, p2=0, shared=0;
  const items = itemsArea.children;
  let summary = `æ—¥ä»˜: ${date}\nåº—: ${shop}\n\n`;

  for (let item of items) {
    const price = parseInt(item.dataset.price);
    const who = item.querySelector("select").value;
    const text = item.textContent.split(" - ")[0];
    if (who==="p1") p1 += price;
    else if (who==="p2") p2 += price;
    else shared += price;
    summary += `${text} Â¥${price} â†’ ${who==="p1"?person1:(who==="p2"?person2:"å‰²ã‚Šå‹˜")}\n`;
  }

  const half = Math.ceil(shared/2);
  summary += `\nå‰²ã‚Šå‹˜åˆè¨ˆ: Â¥${shared} â†’ 1äºº Â¥${half}\n\n`;
  summary += `${person1}: Â¥${p1+half}\n${person2}: Â¥${p2+half}\n`;

  resultArea.value = summary;
}
</script>

</body>
</html>
